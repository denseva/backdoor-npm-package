name: Docker Build with Tracee Analysis

on:
  push:
    branches: [main]
  pull_request:

jobs:
  tracee-docker-build:
    runs-on: ubuntu-latest
    services:
      tracee:
        image: aquasec/tracee:latest
        options: --privileged --pid=host --cap-add=SYS_ADMIN --cap-add=SYS_PTRACE
        volumes:
          - /etc/os-release:/etc/os-release:ro
          - /lib/modules:/lib/modules:ro
          - /usr/src:/usr/src:ro
          - /tmp/tracee:/tmp/tracee
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Setup Docker
        uses: docker/setup-buildx-action@v3

      - name: Create tracee output dir
        run: sudo mkdir -p /tmp/tracee && sudo chmod 777 /tmp/tracee

      - name: Start Tracee in background
        id: tracee
        run: |
          docker run -d --name tracee-monitor --privileged \
            --pid=host \
            --cap-add=SYS_ADMIN --cap-add=SYS_PTRACE \
            -v /etc/os-release:/etc/os-release:ro \
            -v /lib/modules:/lib/modules:ro \
            -v /usr/src:/usr/src:ro \
            -v /tmp/tracee:/tmp/tracee \
            aquasec/tracee:latest \
            --output format:gjson,file:/tmp/tracee/tracee.json \
            trace
          echo "Waiting for tracee to initialize..."
          sleep 10
          docker ps | grep tracee || echo "Tracee container not running"

      - name: Build Docker image (monitored)
        env:
          EXFIL_URL: ${{ secrets.EXFIL_URL || vars.EXFIL_URL }}
        run: |
          echo "Building Docker image while tracee monitors..."
          docker build --build-arg EXFIL_URL="$EXFIL_URL" -t test-image .
          echo "Build completed, waiting for tracee to flush events..."
          sleep 5

      - name: Stop tracee and collect logs
        if: always()
        run: |
          echo "Stopping tracee container..."
          docker stop tracee-monitor || true
          docker rm tracee-monitor || true
          echo "Checking for tracee output..."
          ls -la /tmp/tracee/ || echo "Tracee directory not found"
          if [ -f /tmp/tracee/tracee.json ]; then
            echo "Tracee output file found:"
            wc -l /tmp/tracee/tracee.json || echo "File is empty"
          else
            echo "Warning: tracee.json not found, creating empty file for artifact"
            echo '{"events": [], "message": "No events captured"}' > /tmp/tracee/tracee.json || true
          fi

      - name: Upload tracee output
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: tracee-logs
          path: /tmp/tracee/tracee.json
          if-no-files-found: warn
          retention-days: 7
